version: 2.1
jobs:
  build:
    working_directory: ~/app
    docker:
      - image: circleci/node:latest
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm i
      - run:
          name: Set user
          command: |
            git config --global user.name $CIRCLE_PROJECT_USERNAME &&
            git config --global user.email ${CIRCLE_PROJECT_USERNAME}@users.noreply.github.com
      - run:
          name: Clone main branch
          command: git clone -b main --single-branch $CIRCLE_REPOSITORY_URL dist
      - run:
          name: Clean everything
          command: |
            cd dist &&
            ls -a | grep -v .git | grep -v .circleci | egrep -vU "\.$" | xargs rm -rf &&
            cd -
      - run:
          name: Create page
          command: npm start
      - run:
          name: Check for changes
          command: |
            cd dist &&
            git diff --exit-code && circleci step halt
            cd -
      - run:
          name: Commit
          command: |
            cd dist &&
            git add . &&
            git commit -m "$(curl -s https://whatthecommit.com/index.txt)" &&
            git push origin main --force-with-lease &&
            cd -
workflows:
  version: 2.1
  website:
    jobs:
      - build:
          context: globalenv
          filters:
            branches:
              only:
                - build

  scheduled:
    jobs:
      - build:
          context: globalenv
    triggers:
      - schedule:
          # At 10:00 on every day-of-week from Sunday through Thursday.
          cron: "0 10 * * 0-4"
          filters:
            branches:
              only:
                - build
